<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M510 Tennis</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background-color: #fff;
        }
    </style>
    <script type="module">
        // ハイスコア登録モジュール
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
        import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-database.js";

        // Firebase 設定（自分のプロジェクトの情報を入力）
        const firebaseConfig = {
                apiKey: "AIzaSyDOFYIn_PQSDHRgdjaSIk3uSK50UeYFyIk",
                authDomain: "my-web-game-f7504.firebaseapp.com",
                databaseURL: "https://my-web-game-f7504-default-rtdb.asia-southeast1.firebasedatabase.app/",
                projectId: "my-web-game-f7504",
                storageBucket: "my-web-game-f7504.firebasestorage.app",
                messagingSenderId: "855871162021",
                appId: "1:855871162021:web:29fadb3c0d20ca4f7a2f4c",
        };

        // Firebase 初期化
        const firebase = initializeApp(firebaseConfig);
        const db = getDatabase(firebase);

        function saveHiScore(score) {
            set(ref(db, 'tennis'), {
                hiScore: score
            });
        }
        window.saveHiScore = saveHiScore;

        // ハイスコアを取得
        async function getHiScore() {
            const hiScoreRef = ref(db, "tennis/hiScore");
            try {
                const snapshot = await get(hiScoreRef);
                if (snapshot.exists()) {
                    return snapshot.val() || 0; // 取得した値がundefinedの場合は0を返す
                } else {
                    return 0;
                }
            } catch (error) {
                console.error("Error fetching hiScore:", error);
                return 0;
            }
        }
        window.getHiScore = getHiScore;
</script>
</head>
<body onload="init()">
    <canvas id="canvas" width="700" height="400"></canvas>
    <script>
        // グローバル変数として宣言
        let canvas;
        let ctx;

        class Game {
            constructor(canvasWidth, canvasHeight) {
                this.canvasWidth = canvasWidth;
                this.canvasHeight = canvasHeight;
                this.ball = {
                    x: canvasWidth / 2,     // ボールのx座標
                    y: canvasHeight / 2,    // ボールのy座標
                    radius: 10,             // ボールの半径
                    dx: 2,                  // ボールのx方向の速度
                    dy: 2,                  // ボールのy方向の速度
                };
                this.wallWidth = 10;
                this.racket = {
                    x: canvasWidth / 2,     // ラケットのx座標
                    y: canvasHeight * 0.90, // ラケットのy座標
                    width: 100,             // ラケットの幅
                    height: 10,             // ラケットの高さ
                    dx: 2,                  // ラケットの速度
                    movingLeft: false,      // ラケットが左に移動中かどうか
                    movingRight: false,     // ラケットが右に移動中かどうか
                };
                this.isGameOver = false;    // ゲームオーバーかどうか
                this.score = 0;             // スコア
                this.hiScore = 0;         // ハイスコアを初期化
                this.isNewHiScore = false; // 新しいハイスコアかどうか
            }

            update() {
                if (this.isTitleScreen || this.isGameOver) return;

                const ball = this.ball;
                const racket = this.racket;

                // ボールの位置を更新
                ball.x += ball.dx;
                ball.y += ball.dy;

                // 壁との衝突判定
                if (ball.x - ball.radius - this.wallWidth <= 0 || ball.x + ball.radius + this.wallWidth >= this.canvasWidth) {
                    ball.dx = -ball.dx;
                }
                if (ball.y - ball.radius - this.wallWidth <= 0) {
                    ball.dy = -ball.dy;
                }

                // ラケットとの衝突判定
                if (
                    ball.y + ball.radius >= racket.y &&
                    ball.x >= racket.x &&
                    ball.x <= racket.x + racket.width
                ) {
                    ball.dy = -ball.dy; // ボールの垂直方向の速度を反転
                    this.score += 1;    // スコアを加算
                }

                // ボールが下端からはみ出た場合
                if (ball.y - ball.radius > this.canvasHeight) {
                    this.isGameOver = true;
                }

                // ラケットの移動を更新
                if (racket.movingLeft && racket.x > this.wallWidth) {
                    racket.x -= racket.dx;
                }
                if (racket.movingRight && racket.x + racket.width < this.canvasWidth - this.wallWidth) {
                    racket.x += racket.dx;
                }
            }
            reset() {
                this.ball.x = this.canvasWidth / 2;
                this.ball.y = this.canvasHeight / 2;
                this.ball.dx = 2;
                this.ball.dy = 2;
                this.racket.x = this.canvasWidth / 2 - this.racket.width / 2;
                this.isGameOver = false;
            }

            getState() {
                return {
                    ball: this.ball,
                    wallWidth: this.wallWidth,
                    racket: this.racket,
                    score: this.score,
                    hiScore: this.hiScore,
                };
            }
        }

        function render(ctx, state) {
            const { ball, wallWidth, racket } = state;

            // キャンバスをクリア
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            // 壁を描画
            ctx.fillStyle = "gray";
            ctx.fillRect(0, 0, ctx.canvas.width, wallWidth); // 上の壁
            ctx.fillRect(0, 0, wallWidth, ctx.canvas.height); // 左の壁
            ctx.fillRect(ctx.canvas.width - wallWidth, 0, wallWidth, ctx.canvas.height); // 右の壁

            // ラケットを描画
            ctx.fillStyle = "blue";
            ctx.fillRect(racket.x, racket.y, racket.width, racket.height);

            // ボールを描画
            ctx.beginPath();
            ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
            ctx.fillStyle = "orange";
            ctx.fill();
            ctx.stroke();

            // スコアを描画
            ctx.fillStyle = "black";
            ctx.font = "24px Arial";
            ctx.textAlign = "center";
            ctx.fillText(`Score: ${state.score}`, ctx.canvas.width / 2, 30);
            // ハイスコアを描画
            ctx.fillStyle = "black";
            ctx.font = "18px Arial";
            ctx.textAlign = "center";
            ctx.fillText(`Hi Score: ${state.hiScore}`, ctx.canvas.width / 2, 60);
        }
        function renderTitleScreen(ctx) {
            ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
            ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            ctx.fillStyle = "red";
            ctx.font = "48px Arial";
            ctx.textAlign = "center";
            ctx.fillText("M510 Tennis", ctx.canvas.width / 2, ctx.canvas.height / 2 - 50);

            ctx.font = "24px Arial";
            ctx.fillText("HIT ANY KEY TO START", ctx.canvas.width / 2, ctx.canvas.height / 2 + 20);
        }

        function renderGameOver(ctx, isNewHiScore) {
            ctx.font = "40px Arial";
            ctx.fillStyle = "red";
            ctx.fillText("GAME OVER", ctx.canvas.width / 2, ctx.canvas.height / 2 - 50);

            if (isNewHiScore) {
                ctx.fillStyle = "green";
                ctx.font = "30px Arial";
                ctx.fillText("NEW HI SCORE!", ctx.canvas.width / 2, ctx.canvas.height / 2 + 20);
            }
        }

        function gameLoop(game) {
            if (game.isTitleScreen) {
                render(ctx, game.getState());
                renderTitleScreen(ctx);
                return;
            }

            if (game.isGameOver) {
                // ハイスコアを更新して保存
                if (game.score > game.hiScore) {
                    game.hiScore = game.score;
                    game.isNewHiScore = true; // 新しいハイスコア
                    saveHiScore(game.hiScore); // Firebaseに保存
                } else {
                    game.isNewHiScore = false; // 新しいハイスコアではない
                }
                renderGameOver(ctx, game.isNewHiScore);    // ゲームオーバー画面を表示
                setTimeout(() => {
                    game.isGameOver = false;
                    game.isTitleScreen = true;
                    game.reset();
                    gameLoop(game);
                }, 3000);
                return;                 // ゲームループを終了
            }
            // ゲームロジックを更新
            game.update();
            render(ctx, game.getState());
            requestAnimationFrame(() => gameLoop(game));
        }

        async function init() {
            // canvasとctxを初期化
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");

            // ゲームロジックを管理するインスタンスを作成
            const game = new Game(canvas.width, canvas.height);
            game.isTitleScreen = true;
            // Firebaseからハイスコアを取得
            game.hiScore = await getHiScore();
            // キーボードイベントを設定
            document.addEventListener("keydown", () => {
                if (game.isTitleScreen) {
                    game.isTitleScreen = false;
                    gameLoop(game);
                }
            });
            document.addEventListener("keydown", (e) => {
                if (e.key === "ArrowLeft") {
                    game.racket.movingLeft = true;
                }
                if (e.key === "ArrowRight") {
                    game.racket.movingRight = true;
                }
            });

            document.addEventListener("keyup", (e) => {
                if (e.key === "ArrowLeft") {
                    game.racket.movingLeft = false;
                }
                if (e.key === "ArrowRight") {
                    game.racket.movingRight = false;
                }
            });

            // ゲームループを開始
            gameLoop(game);
        }
    </script>
</body>
</html>