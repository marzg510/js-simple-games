<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>M510 Tennis</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background-color: #fff;
        }
    </style>
    <script src="../firebase_config.js"></script>
    <script type="module" src="./hi_score.js"></script>
</script>
</head>
<body onload="init()">
    <canvas id="canvas" width="700" height="400"></canvas>
    <!-- <script src="./game.js"></script> -->
    <script src="./collision_detector.js"></script>
    <script src="./renderer.js"></script>
    <script type="module">
        import { Game } from './game.js';
        // グローバル変数として宣言
        let canvas, ctx, renderer, game;
        const GAME_OVER_TIMEOUT = 3000; // ゲームオーバー後のタイムアウト期間（ミリ秒）

        // ゲームオーバー時の処理
        function handleGameOver() {
            // ハイスコアを更新して保存
            if (game.score > game.hiScore) {
                game.hiScore = game.score;
                game.isNewHiScore = true; // 新しいハイスコア
                saveHiScore(game.hiScore); // Firebaseに保存
            } else {
                game.isNewHiScore = false; // 新しいハイスコアではない
            }

            // ゲームオーバー画面を描画
            renderer.renderGameOver(game.isNewHiScore);

            // タイトル画面に戻る処理
            setTimeout(() => {
                game.isTitleScreen = true;
                game.reset();
                gameLoop();
            }, GAME_OVER_TIMEOUT);
        }
        function gameLoop() {
            if (game.isTitleScreen) {
                renderer.render(game.getState());
                renderer.renderTitleScreen();
                return;
            }

            if (game.isGameOver) {
                handleGameOver(); // ゲームオーバー処理を呼び出す   
                return;                 // ゲームループを終了
            }
            // ゲームロジックを更新
            game.update();
            renderer.render(game.getState());
            requestAnimationFrame(() => gameLoop());
        }

        async function init() {
            // canvasとctxを初期化
            canvas = document.getElementById("canvas");
            ctx = canvas.getContext("2d");

            renderer = new Renderer(ctx);

            // ゲームロジックを管理するインスタンスを作成
            game = new Game(canvas.width, canvas.height);
            game.isTitleScreen = true;

            // Firebaseからハイスコアを取得
            game.hiScore = await getHiScore();

            // キーボードイベントを設定
            setupKeyboardEvents(game);

            // ゲームループを開始
            gameLoop(game);
        }

        // キーボードイベントを設定する
        function setupKeyboardEvents(game) {
            document.addEventListener("keydown", (e) => {
                if (game.isTitleScreen) {
                    game.isTitleScreen = false;
                    gameLoop();
                }
                if (e.key === "ArrowLeft") game.racket.movingLeft = true;
                if (e.key === "ArrowRight") game.racket.movingRight = true;
            });
            document.addEventListener("keyup", (e) => {
                if (e.key === "ArrowLeft") game.racket.movingLeft = false;
                if (e.key === "ArrowRight") game.racket.movingRight = false;
            });
        }
        window.init = init; // init関数をグローバルに公開
    </script>
</body>
</html>